From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
Date: Sun, 6 Aug 2017 20:42:47 +0200
Subject: [PATCH] classes: baremetal: AArch64: virtio NIC names sync

grep -e "ens[[:digit:]]" -R . -l | \
  xargs sed -i \
    -e 's/ens3/enp1s0/g' \
    -e 's/ens4/enp2s0/g' \
    -e 's/ens5/enp3s0/g' \
    -e 's/ens6/enp4s0/g'

Since AArch64 will be using virtio-net-pci NIC model for guests,
predictable interface naming yields a slightly different scheme.

Update all configuration to reflect this.

NOTE: Above configuration is expected with libvirt 3.x, which puts
each NIC on a separate PCIe bus (which also imposes virtio modern
is used).

Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
---
 .../baremetal-mcp-ocata-ovs-ha/infra/config.yml        |  4 ++--
 .../cluster/baremetal-mcp-ocata-ovs-ha/infra/kvm.yml   | 18 ++++++++++++------
 .../cluster/baremetal-mcp-ocata-ovs-ha/infra/maas.yml  |  8 ++++----
 .../baremetal-mcp-ocata-ovs-ha/openstack/compute.yml   | 18 +++++++++---------
 .../baremetal-mcp-ocata-ovs-ha/openstack/control.yml   |  4 ++--
 .../baremetal-mcp-ocata-ovs-ha/openstack/dashboard.yml |  2 +-
 .../baremetal-mcp-ocata-ovs-ha/openstack/database.yml  |  4 ++--
 .../openstack/message_queue.yml                        |  4 ++--
 .../baremetal-mcp-ocata-ovs-ha/openstack/proxy.yml     |  4 ++--
 .../baremetal-mcp-ocata-ovs-ha/openstack/telemetry.yml |  4 ++--
 10 files changed, 38 insertions(+), 32 deletions(-)

diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/config.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/config.yml
index 77443de..824b979 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/config.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/config.yml
@@ -33,8 +33,8 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_dhcp_interface}
-        ens4: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_dhcp_interface}
+        enp2s0: ${_param:linux_single_interface}
   salt:
     master:
       accept_policy: open_mode
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/kvm.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/kvm.yml
index 5c33f9e..8b09e76 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/kvm.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/kvm.yml
@@ -25,7 +25,8 @@ parameters:
     cluster_node03_address: ${_param:infra_kvm_node03_address}
     keepalived_vip_interface: br-ctl
     keepalived_vip_virtual_router_id: 69
-    deploy_nic: enp6s0
+    deploy_nic: eth0
+    trunk_nic: eth1
   salt:
     control:
       size: #RAM 4096,8192,16384,32768,65536
@@ -115,7 +116,7 @@ parameters:
   linux:
     network:
       interface:
-        eth3:
+        eth0:
           enabled: true
           type: eth
           proto: manual
@@ -123,6 +124,11 @@ parameters:
           netmask: 255.255.255.0
           name: ${_param:deploy_nic}
           noifupdown: true
+        eth1:
+          enabled: true
+          type: eth
+          proto: manual
+          name: ${_param:trunk_nic}
         br-mgmt:
           enabled: true
           proto: dhcp
@@ -133,13 +139,13 @@ parameters:
           use_interfaces:
           - ${_param:deploy_nic}
           noifupdown: true
-        vlan300:
+        vlan2183:
           enabled: true
           proto: manual
           type: vlan
-          name: ${_param:deploy_nic}.300
+          name: ${_param:trunk_nic}.2183
           use_interfaces:
-          - ${_param:deploy_nic}
+          - ${_param:trunk_nic}
         br-ctl:
           enabled: true
           type: bridge
@@ -147,4 +153,4 @@ parameters:
           address: ${_param:single_address}
           netmask: 255.255.255.0
           use_interfaces:
-          - ${_param:deploy_nic}.300
+          - ${_param:trunk_nic}.2183
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/maas.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/maas.yml
index 7fc45e2..428a74b 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/maas.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/infra/maas.yml
@@ -4,10 +4,10 @@ classes:
 - cluster.baremetal-mcp-ocata-ovs-ha.infra
 parameters:
   _param:
-    dhcp_interface: ens3
-    primary_interface: ens4
-    pxe_interface: ens5
-    external_interface: ens6
+    dhcp_interface: enp1s0
+    primary_interface: enp2s0
+    pxe_interface: enp3s0
+    external_interface: enp4s0
     interface_mtu: 1500
     # MaaS has issues using MTU > 1500 for PXE interface
     pxe_interface_mtu: 1500
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/compute.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/compute.yml
index 18a7a0b..d052e23 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/compute.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/compute.yml
@@ -19,8 +19,8 @@ parameters:
     cluster_node03_hostname: ctl03
     cluster_node03_address: ${_param:openstack_control_node03_address}
     nova_vncproxy_url: https://${_param:cluster_public_host}:6080
-    mgmt_nic: enp6s0
-    tenant_nic: enp7s0
+    mgmt_nic: eth0
+    tenant_nic: eth1
     linux_system_codename: xenial
   linux:
     network:
@@ -43,19 +43,19 @@ parameters:
           netmask: 255.255.255.0
           mtu: 1500
           use_interfaces:
-          - ${_param:tenant_nic}.302
-        vlan300:
+          - ${_param:tenant_nic}.2185
+        vlan2183:
           enabled: true
           proto: manual
           type: vlan
-          name: ${_param:mgmt_nic}.300
+          name: ${_param:tenant_nic}.2183
           use_interfaces:
-          - ${_param:mgmt_nic}
-        vlan302:
+          - ${_param:tenant_nic}
+        vlan2185:
           enabled: true
           proto: manual
           type: vlan
-          name: ${_param:tenant_nic}.302
+          name: ${_param:tenant_nic}.2185
           use_interfaces:
           - ${_param:tenant_nic}
         br-ctl:
@@ -65,4 +65,4 @@ parameters:
           address: ${_param:single_address}
           netmask: 255.255.255.0
           use_interfaces:
-          - ${_param:mgmt_nic}.300
+          - ${_param:tenant_nic}.2183
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/control.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/control.yml
index 995c50c..97f44ca 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/control.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/control.yml
@@ -23,7 +23,7 @@ classes:
 - cluster.baremetal-mcp-ocata-ovs-ha.infra
 parameters:
   _param:
-    keepalived_vip_interface: ens3
+    keepalived_vip_interface: enp1s0
     keepalived_vip_virtual_router_id: 50
     cluster_vip_address: ${_param:openstack_control_address}
     cluster_local_address: ${_param:single_address}
@@ -37,7 +37,7 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
   bind:
     server:
       control:
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/dashboard.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/dashboard.yml
index b7ed814..bfca091 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/dashboard.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/dashboard.yml
@@ -7,4 +7,4 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/database.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/database.yml
index c0e21aa..3fcf34b 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/database.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/database.yml
@@ -16,7 +16,7 @@ classes:
 - cluster.baremetal-mcp-ocata-ovs-ha
 parameters:
   _param:
-    keepalived_vip_interface: ens3
+    keepalived_vip_interface: enp1s0
     keepalived_vip_virtual_router_id: 80
     galera_server_cluster_name: openstack_cluster
     cluster_vip_address: ${_param:openstack_database_address}
@@ -30,4 +30,4 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/message_queue.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/message_queue.yml
index 3b79030..4910196 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/message_queue.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/message_queue.yml
@@ -7,7 +7,7 @@ classes:
 - cluster.baremetal-mcp-ocata-ovs-ha
 parameters:
   _param:
-    keepalived_vip_interface: ens3
+    keepalived_vip_interface: enp1s0
     keepalived_vip_virtual_router_id: 90
     cluster_vip_address: ${_param:openstack_message_queue_address}
     cluster_local_address: ${_param:single_address}
@@ -20,4 +20,4 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/proxy.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/proxy.yml
index 2695c96..d146d8a 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/proxy.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/proxy.yml
@@ -15,7 +15,7 @@ classes:
 # - cluster.baremetal-mcp-ocata-ovs-ha.stacklight.proxy
 parameters:
   _param:
-    keepalived_vip_interface: ens3
+    keepalived_vip_interface: enp1s0
     keepalived_vip_virtual_router_id: 240
     nginx_proxy_ssl:
       enabled: true
@@ -27,7 +27,7 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
     system:
       package:
         libapache2-mod-wsgi:
diff --git a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/telemetry.yml b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/telemetry.yml
index ca655dd..69ca07f 100644
--- a/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/telemetry.yml
+++ b/mcp/reclass/classes/cluster/baremetal-mcp-ocata-ovs-ha/openstack/telemetry.yml
@@ -10,7 +10,7 @@ classes:
 - cluster.baremetal-mcp-ocata-ovs-ha.infra
 parameters:
   _param:
-    keepalived_vip_interface: ens3
+    keepalived_vip_interface: enp1s0
     keepalived_vip_virtual_router_id: 230
     cluster_vip_address: ${_param:openstack_telemetry_address}
     cluster_local_address: ${_param:single_address}
@@ -23,4 +23,4 @@ parameters:
   linux:
     network:
       interface:
-        ens3: ${_param:linux_single_interface}
+        enp1s0: ${_param:linux_single_interface}
