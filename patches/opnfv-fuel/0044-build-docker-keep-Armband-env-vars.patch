From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
Date: Fri, 12 Aug 2016 14:53:39 +0200
Subject: [PATCH] build: docker: keep Armband env vars

Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
---
 build/docker/Dockerfile |  2 ++
 build/docker/runcontext | 12 +++++++++++-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/build/docker/Dockerfile b/build/docker/Dockerfile
index 1bb56b7..1cb32dd 100644
--- a/build/docker/Dockerfile
+++ b/build/docker/Dockerfile
@@ -31,10 +31,12 @@ RUN echo "Defaults env_keep += \"ftp_proxy http_proxy https_proxy no_proxy RSYNC
 RUN echo "Defaults env_keep += \"PWD\"" > /etc/sudoers.d/keep-pwd
 # Keeping variables for ISO build
 RUN echo "Defaults env_keep += \"MIRROR_UBUNTU MIRROR_UBUNTU_ROOT MIRROR_MOS_UBUNTU MIRROR_MOS_UBUNTU_ROOT MIRROR_FUEL LATEST_TARGET_UBUNTU\"" > /etc/sudoers.d/keep-mos
+RUN echo "Defaults env_keep += \"ARMBAND_BASE UBUNTU_ARCH\"" > /etc/sudoers.d/keep-armband
 RUN chmod 0440 /etc/sudoers.d/open-sudo
 RUN chmod 0440 /etc/sudoers.d/keep-proxies
 RUN chmod 0440 /etc/sudoers.d/keep-pwd
 RUN chmod 0440 /etc/sudoers.d/keep-mos
+RUN chmod 0440 /etc/sudoers.d/keep-armband
 RUN chmod 4755 /bin/fusermount
 
 ADD ./setcontext /root/setcontext
diff --git a/build/docker/runcontext b/build/docker/runcontext
index 9f07776..90b5bae 100755
--- a/build/docker/runcontext
+++ b/build/docker/runcontext
@@ -42,6 +42,10 @@ GITROOT=`git rev-parse --show-toplevel`
 CID_FILE=`mktemp -u -t runcontext.XXXXXXXXXX`
 CONTEXT_DIR=`mktemp -d ${GITROOT}/.docker_contextXXXXXX`
 
+if [[ $ARMBAND_BASE ]]; then
+    GITROOT=$ARMBAND_BASE
+fi
+
 # If RSYNC_CONNECT_PROG is used, we need to copy all of
 # the SSH structure, should one of the keys need to be
 # used.
@@ -111,7 +115,13 @@ if [ -n "$CACHEBASE" ]; then
     fi
 fi
 
-RUN_CONTEXT_OPT="--cidfile $CID_FILE --privileged=true --rm -e HOME=$HOME -e CACHEDEBUG -e CACHETRANSPORT -e CACHEMAXAGE -e CACHEBASE -e BUILD_FUEL_PLUGINS -e MIRROR_UBUNTU -e MIRROR_UBUNTU_ROOT -e MIRROR_MOS_UBUNTU -e MIRROR_MOS_UBUNTU_ROOT -e MIRROR_FUEL -e LATEST_TARGET_UBUNTU -u $USER_ID:$GROUP_ID -w $PWD -v $GITROOT:$GITROOT -v /sys/fs/cgroup:/sys/fs/cgroup:ro $CACHEMOUNT"
+RUN_CONTEXT_OPT="--cidfile $CID_FILE --privileged=true --rm \
+  -e HOME=$HOME -e CACHEDEBUG -e CACHETRANSPORT -e CACHEMAXAGE -e CACHEBASE \
+  -e BUILD_FUEL_PLUGINS -e MIRROR_UBUNTU -e MIRROR_UBUNTU_ROOT -e MIRROR_MOS_UBUNTU \
+  -e MIRROR_MOS_UBUNTU_ROOT -e MIRROR_FUEL -e LATEST_TARGET_UBUNTU \
+  -e ARMBAND_BASE UBUNTU_ARCH \
+  -u $USER_ID:$GROUP_ID -w $PWD \
+  -v $GITROOT:$GITROOT -v /sys/fs/cgroup:/sys/fs/cgroup:ro $CACHEMOUNT"
 
 # Passing "debug" puts up an interactive bash shell
 if [ "$1" == "debug" ]; then
