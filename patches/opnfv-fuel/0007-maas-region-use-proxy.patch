From ddf4b413b0c8dddd2d9c14412103563780a15e4e Mon Sep 17 00:00:00 2001
From: chko <Charalampos.Kominos@enea.com>
Date: Fri, 18 Aug 2017 19:34:39 +0200
Subject: [PATCH] Fixed maas 503 error

---
 mcp/patches/0007-maas-region-use-proxy.patch       | 29 ++++++++
 mcp/patches/patches.list                           |  1 +
 ...1-linux-system-repo-mcp-Add-Armband-repos.patch | 85 ++++++++++++++++++++++
 .../0002-linux-system-AArch64-Remove-mcelog.patch  | 26 +++++++
 4 files changed, 141 insertions(+)
 create mode 100644 mcp/patches/0007-maas-region-use-proxy.patch
 create mode 100644 mcp/patches/reclass-system-salt-model/armband/0001-linux-system-repo-mcp-Add-Armband-repos.patch
 create mode 100644 mcp/patches/reclass-system-salt-model/armband/0002-linux-system-AArch64-Remove-mcelog.patch

diff --git a/mcp/patches/0007-maas-region-use-proxy.patch b/mcp/patches/0007-maas-region-use-proxy.patch
new file mode 100644
index 0000000..4474950
--- /dev/null
+++ b/mcp/patches/0007-maas-region-use-proxy.patch
@@ -0,0 +1,29 @@
+From: Charalampos Kominos <charalampos.kominos@enea.com>
+Date: Fre, 18 Aug 2017 18:12:01 +0200
+Subject: [PATCH] maas.region fix
+
+Patching maas http requests from localhost
+
+Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+Signed-off-by: Charalampos Kominos <Charalampos.Kominos@enea.com>
+Signed-off-by: Guillermo Herrero <Guillermo.Herrero@enea.com>
+---
+
+diff --git a/maas/region.sls b/maas/region.sls
+index d3227ca..8a2243d 100644
+--- a/maas/region.sls
++++ b/maas/region.sls
+@@ -12,6 +12,11 @@
+   - require:
+     - pkg: maas_region_packages
+ 
++/etc/environment:
++  file.append:
++  - name: /etc/environment
++  - text: 'no_proxy="localhost,127.0.0.1,::1"'
++
+ /usr/lib/python3/dist-packages/provisioningserver/templates/proxy/maas-proxy.conf.template:
+   file.managed:
+   - source: salt://maas/files/maas-proxy.conf.template
+
+
diff --git a/mcp/patches/patches.list b/mcp/patches/patches.list
index 8bc328a..8385e7d 100644
--- a/mcp/patches/patches.list
+++ b/mcp/patches/patches.list
@@ -5,3 +5,4 @@
 /usr/share/salt-formulas/env: 0005-maas-vlan-DHCP-enable-on-fabric-2.patch
 /usr/share/salt-formulas/env: 0006-linux.network.interface-noifupdown-support.patch
 /usr/share/salt-formulas/env: 0101-maas-Add-curtin_userdata_arm64_generic_xenial.patch
+/usr/share/salt-formulas/env: 0007-maas-region-use-proxy.patch
diff --git a/mcp/patches/reclass-system-salt-model/armband/0001-linux-system-repo-mcp-Add-Armband-repos.patch b/mcp/patches/reclass-system-salt-model/armband/0001-linux-system-repo-mcp-Add-Armband-repos.patch
new file mode 100644
index 0000000..3fa4b7c
--- /dev/null
+++ b/mcp/patches/reclass-system-salt-model/armband/0001-linux-system-repo-mcp-Add-Armband-repos.patch
@@ -0,0 +1,85 @@
+From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+Date: Mon, 10 Jul 2017 15:31:08 +0000
+Subject: [PATCH] linux/system/repo/mcp: Add Armband repos
+
+FIXME: Use https for fetching Armband GPG key!
+
+Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+---
+ linux/system/repo/mcp/extra.yml     |  9 +++++++
+ linux/system/repo/mcp/openstack.yml | 48 +++++++++++++++++++++++++++++++++++++
+ 2 files changed, 57 insertions(+)
+
+diff --git a/linux/system/repo/mcp/extra.yml b/linux/system/repo/mcp/extra.yml
+index 826969b..01b9cc5 100644
+--- a/linux/system/repo/mcp/extra.yml
++++ b/linux/system/repo/mcp/extra.yml
+@@ -14,3 +14,12 @@ parameters:
+           - pin: 'release a=${_param:linux_system_repo_mcp_extra_version}'
+             priority: 1100
+             package: '*'
++        armband_mcp_extra:
++          source: "deb [arch=arm64] http://linux.enea.com/apt-mk/${_param:linux_system_codename}/ ${_param:linux_system_repo_mcp_extra_version} extra"
++          architectures: arm64
++          key_url: "http://linux.enea.com/apt-mk/public.gpg"
++          clean_file: true
++          pin:
++          - pin: 'release a=${_param:linux_system_repo_mcp_extra_version}'
++            priority: 1100
++            package: '*'
+diff --git a/linux/system/repo/mcp/openstack.yml b/linux/system/repo/mcp/openstack.yml
+index 2235b2c..be8ffd2 100644
+--- a/linux/system/repo/mcp/openstack.yml
++++ b/linux/system/repo/mcp/openstack.yml
+@@ -53,3 +53,51 @@ parameters:
+           - pin: 'release a=${_param:linux_system_repo_mk_openstack_version}'
+             priority: 1100
+             package: '*'
++        armband_openstack:
++          source: "deb http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename} ${_param:openstack_version} main"
++          architectures: arm64
++          key_url: "http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename}/archive-mcp${_param:openstack_version}.key"
++          pin:
++          - pin: 'release a=${_param:openstack_version}'
++            priority: 1100
++            package: '*'
++        armband_openstack_hotfix:
++          source: "deb http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename} ${_param:openstack_version}-hotfix main"
++          architectures: arm64
++          key_url: "http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename}/archive-mcp${_param:openstack_version}.key"
++          pin:
++          - pin: 'release a=${_param:openstack_version}-hotfix'
++            priority: 1100
++            package: '*'
++        armband_openstack_security:
++          source: "deb http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename} ${_param:openstack_version}-security main"
++          architectures: arm64
++          key_url: "http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename}/archive-mcp${_param:openstack_version}.key"
++          pin:
++          - pin: 'release a=${_param:openstack_version}-security'
++            priority: 1100
++            package: '*'
++        armband_openstack_updates:
++          source: "deb http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename} ${_param:openstack_version}-updates main"
++          architectures: arm64
++          key_url: "http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename}/archive-mcp${_param:openstack_version}.key"
++          pin:
++          - pin: 'release a=${_param:openstack_version}-updates'
++            priority: 1100
++            package: '*'
++        armband_openstack_holdback:
++          source: "deb http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename} ${_param:openstack_version}-holdback main"
++          architectures: arm64
++          key_url: "http://linux.enea.com/mcp-repos/${_param:openstack_version}/${_param:linux_system_codename}/archive-mcp${_param:openstack_version}.key"
++          pin:
++          - pin: 'release a=${_param:openstack_version}-holdback'
++            priority: 1100
++            package: '*'
++        armband_mk_openstack:
++          source: "deb [arch=arm64] http://linux.enea.com/apt-mk/${_param:linux_system_codename}/ ${_param:linux_system_repo_mk_openstack_version} ${_param:openstack_version}"
++          architectures: arm64
++          key_url: "http://linux.enea.com/apt-mk/public.gpg"
++          pin:
++          - pin: 'release a=${_param:linux_system_repo_mk_openstack_version}'
++            priority: 1100
++            package: '*'
diff --git a/mcp/patches/reclass-system-salt-model/armband/0002-linux-system-AArch64-Remove-mcelog.patch b/mcp/patches/reclass-system-salt-model/armband/0002-linux-system-AArch64-Remove-mcelog.patch
new file mode 100644
index 0000000..2c6348d
--- /dev/null
+++ b/mcp/patches/reclass-system-salt-model/armband/0002-linux-system-AArch64-Remove-mcelog.patch
@@ -0,0 +1,26 @@
+From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+Date: Fri, 14 Jul 2017 19:26:11 +0000
+Subject: [PATCH] linux/system: AArch64: Remove mcelog
+
+mcelog is not available on AArch64 hardware, so skip trying to install
+it. This implies Ceilometer should not use mcelog on AArch64.
+
+Signed-off-by: Guillermo Herrero <Guillermo.Herrero@enea.com>
+Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+---
+ linux/system/single.yml | 2 --
+ 1 file changed, 2 deletions(-)
+
+diff --git a/linux/system/single.yml b/linux/system/single.yml
+index ef23a39..f07fa68 100644
+--- a/linux/system/single.yml
++++ b/linux/system/single.yml
+@@ -11,8 +11,6 @@ parameters:
+           version: latest
+         cloud-init:
+           version: purged
+-        mcelog:
+-          version: latest
+       kernel:
+         modules:
+           - nf_conntrack
-- 
2.7.4

