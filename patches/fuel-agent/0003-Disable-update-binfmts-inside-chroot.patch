From: Stanislaw Kardach <stanislaw.kardach@caviumnetworks.com>
Date: Sun, 6 Mar 2016 16:09:39 +0100
Subject: [PATCH] Disable update-binfmts inside chroot

---
 fuel_agent/manager.py     |  6 ++++++
 fuel_agent/utils/build.py | 11 +++++++++++
 2 files changed, 17 insertions(+)

diff --git a/fuel_agent/manager.py b/fuel_agent/manager.py
index f613aef..5045b0b 100644
--- a/fuel_agent/manager.py
+++ b/fuel_agent/manager.py
@@ -587,6 +587,12 @@ class Manager(object):
         fu.mount_bind(chroot, '/proc')
         bu.populate_basic_dev(chroot)
 
+        # we need to disable binfmt handler updates inside chroot
+        # because we've created chroot possibly using them with
+        # qemu-debootstrap
+        LOG.debug('Preventing update-binfmts calls inside chroot')
+        bu.disable_binfmt(chroot)
+
     def destroy_chroot(self, chroot):
         # Umount chroot tree and remove images tmp files
         if not bu.stop_chrooted_processes(chroot, signal=signal.SIGTERM):
diff --git a/fuel_agent/utils/build.py b/fuel_agent/utils/build.py
index 6f31732..9756b26 100644
--- a/fuel_agent/utils/build.py
+++ b/fuel_agent/utils/build.py
@@ -312,6 +312,17 @@ def populate_basic_dev(chroot):
     utils.execute('chroot', chroot,
                   'ln', '-s', '/proc/self/fd', '/dev/fd')
 
+def disable_binfmt(chroot):
+    """Disables binfmt handler manipulation inside chroot.
+
+    Redirects /usr/sbin/update-binfmts to /bin/true if it exists or
+    creates a symlink if update-binfmts doesn't exist. Also uses
+    dpkg-divert to disable any dpkg attempt for overwriting."""
+    utils.execute('chroot', chroot, 'ln', '-sf', '/bin/true',
+                  '/usr/sbin/update-binfmts')
+    utils.execute('chroot', chroot,
+                  'dpkg-divert', '--divert', '/usr/sbin/update-binfmts.orig',
+                  '--rename', '/usr/sbin/update-binfmts')
 
 def create_sparse_tmp_file(dir, suffix, size=8192):
     """Creates sparse file.
-- 
1.9.1

