From 1bbe2f7803b7cb2c51d1864af303658bf9e1e4bf Mon Sep 17 00:00:00 2001
From: Stanislaw Kardach <stanislaw.kardach@caviumnetworks.com>
Date: Thu, 25 Feb 2016 13:38:14 +0100
Subject: [PATCH] Use qemu-debootstrap for image creation

This commit adds qemu-debootstrap support and a command line argument
`target_arch` which can be used for choosing the architecture to build
the image for. The architecture detection from environment settings is
not yet implemented.
---
 debian/control                       |  2 +-
 fuel_agent/manager.py                | 12 +++++++++++-
 fuel_agent/tests/test_build_utils.py |  4 ++--
 fuel_agent/utils/build.py            |  2 +-
 specs/fuel-agent.spec                |  2 +-
 5 files changed, 16 insertions(+), 6 deletions(-)

diff --git a/debian/control b/debian/control
index 0a6f947..e7cb0cb 100644
--- a/debian/control
+++ b/debian/control
@@ -35,7 +35,7 @@ Section: python
 Pre-Depends: dpkg (>= 1.15.6~)
 Depends: bzip2,
          cloud-utils,
-	 debootstrap,
+	 qemu-user-static,
 	 dmidecode,
 	 ethtool,
 	 gdisk,
diff --git a/fuel_agent/manager.py b/fuel_agent/manager.py
index 15cc5d8..528bb0a 100644
--- a/fuel_agent/manager.py
+++ b/fuel_agent/manager.py
@@ -18,6 +18,7 @@ import shutil
 import signal
 
 from oslo_config import cfg
+from oslo_config import types
 import six
 import yaml
 
@@ -33,6 +34,8 @@ from fuel_agent.utils import md as mu
 from fuel_agent.utils import partition as pu
 from fuel_agent.utils import utils
 
+ArchType = types.String(choices=['amd64', 'arm64'])
+
 opts = [
     cfg.StrOpt(
         'nc_template_path',
@@ -153,6 +156,12 @@ cli_opts = [
         default='/tmp',
         help='Directory where the image is supposed to be built',
     ),
+    cfg.StrOpt(
+        'target_arch',
+        default='amd64',
+        help='Architecture for which image will be built using '
+             'debootstrap',
+    ),
 ]
 
 CONF = cfg.CONF
@@ -551,7 +560,8 @@ class Manager(object):
         LOG.debug('Preventing services from being get started')
         bu.suppress_services_start(chroot)
         LOG.debug('Installing base operating system using debootstrap')
-        bu.run_debootstrap(uri=uri, suite=suite, chroot=chroot,
+        bu.run_debootstrap(uri=uri, suite=suite, arch=CONF.target_arch,
+                           chroot=chroot,
                            attempts=CONF.fetch_packages_attempts,
                            proxies=proxies.proxies,
                            direct_repo_addr=proxies.direct_repo_addr_list)
diff --git a/fuel_agent/tests/test_build_utils.py b/fuel_agent/tests/test_build_utils.py
index 82c3462..ac5ae82 100644
--- a/fuel_agent/tests/test_build_utils.py
+++ b/fuel_agent/tests/test_build_utils.py
@@ -42,7 +42,7 @@ class BuildUtilsTestCase(unittest2.TestCase):
     def test_run_debootstrap(self, mock_exec, mock_environ):
         bu.run_debootstrap('uri', 'suite', 'chroot', 'arch', attempts=2)
         mock_exec.assert_called_once_with(
-            'debootstrap', '--include={0}'
+            'qemu-debootstrap', '--include={0}'
             .format(','.join(bu.ADDITIONAL_DEBOOTSTRAP_PACKAGES)),
             '--verbose', '--no-check-gpg', '--arch=arch',
             'suite', 'chroot', 'uri', attempts=2, env_variables={})
@@ -53,7 +53,7 @@ class BuildUtilsTestCase(unittest2.TestCase):
         bu.run_debootstrap('uri', 'suite', 'chroot', 'arch', eatmydata=True,
                            attempts=2)
         mock_exec.assert_called_once_with(
-            'debootstrap', '--include={0}'
+            'qemu-debootstrap', '--include={0}'
             .format(','.join(bu.ADDITIONAL_DEBOOTSTRAP_PACKAGES)),
             '--verbose', '--no-check-gpg', '--arch=arch',
             '--include=eatmydata', 'suite',
diff --git a/fuel_agent/utils/build.py b/fuel_agent/utils/build.py
index 7247965..af41b2b 100644
--- a/fuel_agent/utils/build.py
+++ b/fuel_agent/utils/build.py
@@ -80,7 +80,7 @@ def run_debootstrap(uri, suite, chroot, arch='amd64', eatmydata=False,
         env_vars['no_proxy'] = ','.join(direct_repo_addr)
         LOG.debug('Setting no_proxy for: {0}'.format(env_vars['no_proxy']))
 
-    cmds = ['debootstrap',
+    cmds = ['qemu-debootstrap',
             '--include={0}'.format(",".join(ADDITIONAL_DEBOOTSTRAP_PACKAGES)),
             '--verbose', '--no-check-gpg',
             '--arch={0}'.format(arch)]
diff --git a/specs/fuel-agent.spec b/specs/fuel-agent.spec
index 5c37600..2f56ff1 100644
--- a/specs/fuel-agent.spec
+++ b/specs/fuel-agent.spec
@@ -49,7 +49,7 @@ Requires:    genisoimage
 Requires:    xfsprogs
 Requires:    pciutils
 Requires:    ethtool
-Requires:    debootstrap
+Requires:    qemu-user-static
 Requires:    xz
 Requires:    coreutils
 Requires:    psmisc
-- 
1.9.1

